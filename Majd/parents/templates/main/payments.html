{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Payments{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold">Payments</h3>
      <p class="text-muted">Manage payment history, methods, and upcoming payments</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary">
        <i class="bi bi-download"></i> Export
      </button>
      <a href="{% url 'parents:subscriptions' %}" class="btn btn-outline-success me-2">
        <i class="bi bi-building"></i> Browse Academies
      </a>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#paymentModal">
        <i class="bi bi-plus-lg"></i> Make Payment
      </button>
    </div>
  </div>

 
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm border-0 p-3 h-100">
        <h6 class="text-muted">This Month</h6>
        <h3 class="fw-bold">SAR {{ total_paid }}</h3>
        <small class="text-success">Total Paid</small>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 p-3 h-100">
        <h6 class="text-muted">Outstanding</h6>
        <h3 class="fw-bold">SAR {{ outstanding }}</h3>
        <small class="text-warning">Due Soon</small>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 p-3 h-100">
        <h6 class="text-muted">Next Payment</h6>
        <h3 class="fw-bold">SAR {{ next_payment.amount }}</h3>
        <small class="text-success">Due {{ next_payment.date|date:"M d, Y" }}</small>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-pills mb-4 gap-2">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="pill" href="#history">History</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="pill" href="#upcoming">Upcoming</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="pill" href="#subscriptions">Available Plans</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="pill" href="#methods">Payment Methods</a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">

    <!-- History -->
    <div class="tab-pane fade show active" id="history">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold">Payment History</h5>
            <button class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-download"></i> Download All
            </button>
          </div>

          {% for payment in payments %}
          <div class="d-flex justify-content-between align-items-center border-bottom py-3">
            <div class="d-flex align-items-center gap-3">
              <!-- Avatar -->
              <div class="rounded-circle bg-success text-white fw-bold d-flex justify-content-center align-items-center"
                   style="width: 45px; height: 45px;">
                {{ payment.child.first_name|slice:":1"|upper }}
              </div>
              <div>
                <h6 class="mb-0 fw-bold">{{ payment.child.first_name }} {{ payment.child.last_name }}</h6>
                <small class="text-muted">{{ payment.description }}</small><br>
                <small class="text-muted">{{ payment.academy_name }}</small><br>
                <span class="badge {% if payment.status == 'paid' %}bg-success-subtle text-success
                                   {% elif payment.status == 'not_paid' %}bg-danger-subtle text-danger
                                   {% elif payment.status == 'pending' %}bg-warning-subtle text-warning
                                   {% else %}bg-secondary-subtle text-secondary{% endif %}">
                  {% if payment.status == 'not_paid' %}Not Paid{% else %}{{ payment.status|title }}{% endif %}
                </span>
              </div>
            </div>

            <!-- Right Side -->
            <div class="text-end">
              <h6 class="fw-bold mb-1">SAR {{ payment.amount }}</h6>
              <small class="text-muted">{{ payment.date|date:"M d, Y" }}</small><br>
              {% if payment.status == 'not_paid' %}
                <button class="btn btn-success btn-sm mt-1" onclick="makePayment('{{ payment.academy_name|escapejs }}', '{{ payment.description|escapejs }}', {{ payment.amount }}, {{ payment.enrollment.id }})">
                  Pay Now
                </button>
              {% else %}
                <a href="#" class="btn btn-outline-secondary btn-sm mt-1">View Receipt</a>
              {% endif %}
            </div>
          </div>
          {% empty %}
            <p class="text-muted">No payments found.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Upcoming -->
    <div class="tab-pane fade" id="upcoming">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="fw-bold">Upcoming Payments</h5>
          <p class="text-muted">Your upcoming scheduled fees and invoices.</p>
          {% for item in upcoming %}
            <div class="d-flex justify-content-between align-items-center border-bottom py-3">
              <div>
                <strong>{{ item.child }} - {{ item.program }}</strong><br>
                <small class="text-muted">{{ item.academy }}</small>
              </div>
              <div class="text-end">
                <h6 class="fw-bold mb-1">SAR {{ item.amount }}</h6>
                <small class="text-muted">Due {{ item.date|date:"M d, Y" }}</small><br>
                <button class="btn btn-success btn-sm mt-1" onclick="makePayment('{{ item.academy|escapejs }}', '{{ item.program|escapejs }}', {{ item.amount }})">
                  Pay Now
                </button>
              </div>
            </div>
          {% empty %}
            <p class="text-muted">No upcoming payments.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Available Subscription Plans -->
    <div class="tab-pane fade" id="subscriptions">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          {% if required_academy %}
            <h5 class="fw-bold">Required Academy Subscription</h5>
            <div class="alert alert-warning mb-3">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Subscription Required:</strong> You need to subscribe to <strong>{{ required_academy.name }}</strong> before enrolling your children in their programs.
            </div>
          {% else %}
            <h5 class="fw-bold">Available Academy Subscription Plans</h5>
            <p class="text-muted">Subscribe to an academy to enroll your children in their programs.</p>
          {% endif %}
          
          {% for plan_data in available_subscription_plans %}
          <div class="d-flex justify-content-between align-items-center border-bottom py-3 {% if plan_data.is_required %}bg-warning bg-opacity-10 border-warning{% endif %}">
            <div class="d-flex align-items-center gap-3">
          
              <div class="rounded-circle bg-success text-white fw-bold d-flex align-items-center justify-content-center"
                   style="width: 45px; height: 45px;">
                {{ plan_data.academy.name|slice:":3"|upper }}
              </div>
              <div>
                <h6 class="mb-0 fw-bold">{{ plan_data.academy.name }}
                  {% if plan_data.is_required %}
                    <span class="badge bg-warning text-dark ms-2">Required</span>
                  {% endif %}
                </h6>
                <small class="text-muted">{{ plan_data.academy.city }}</small><br>
                <small class="text-muted">{{ plan_data.plan_type }}</small>
                {% if plan_data.subscription_plan and plan_data.subscription_plan.description %}
                <br><small class="text-muted">{{ plan_data.subscription_plan.description|truncatewords:15 }}</small>
                {% endif %}
              </div>
            </div>

            <!-- Right Side -->
            <div class="text-end">
              <h6 class="fw-bold mb-1">SAR {{ plan_data.price }}/month</h6>
              <small class="text-muted">{% if plan_data.subscription_plan %}{{ plan_data.subscription_plan.billing_type|title }}{% else %}Monthly{% endif %}</small><br>
              <button class="btn btn-success btn-sm mt-1" onclick="subscribeToAcademy('{{ plan_data.academy.name|escapejs }}', {{ plan_data.price }}, '{{ plan_data.academy.slug|escapejs }}')">
                Subscribe Now
              </button>
            </div>
          </div>
          {% empty %}
            <div class="text-center py-5">
              <i class="bi bi-building display-1 text-muted"></i>
              <h5 class="text-muted mt-3">No Subscription Plans Available</h5>
              <p class="text-muted">Contact academy administrators to set up subscription plans.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="tab-pane fade" id="methods">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="fw-bold">Payment Methods</h5>
          <p class="text-muted">Manage your saved payment methods.</p>
          {% for method in methods %}
            <div class="d-flex justify-content-between align-items-center border-bottom py-3">
              <div class="d-flex align-items-center gap-3">
                <i class="bi {{ method.icon }} fs-4 text-success"></i>
                <div>
                  <strong>{{ method.name }}</strong><br>
                  <small class="text-muted">{{ method.description }}</small>
                </div>
              </div>
              <div class="text-end">
                <button class="btn btn-outline-success btn-sm" onclick="selectPaymentMethod('{{ method.name }}')">
                  Select
                </button>
              </div>
            </div>
          {% empty %}
            <p class="text-muted">No payment methods available.</p>
          {% endfor %}
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="fw-bold mb-0">Complete Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Order Summary -->
          <div class="col-lg-5 mb-4">
            <div class="card h-100">
              <div class="card-header">
                <h6 class="mb-0">Payment Summary</h6>
              </div>
              <div class="card-body">
                <!-- Selected Program -->
                <div class="selected-program mb-4">
                  <div class="d-flex align-items-center mb-3">
                    <div class="program-icon me-3 bg-success text-white rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 50px; height: 50px;">
                      <i class="bi bi-person-check"></i>
                    </div>
                    <div>
                      <h6 class="mb-1" id="summaryProgram">Program Name</h6>
                      <span class="badge bg-success" id="summaryAcademy">Academy Name</span>
                    </div>
                  </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="cost-breakdown">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Program Fee:</span>
                    <span id="summaryAmount">SAR 0</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>VAT (15%):</span>
                    <span id="summaryVat">SAR 0</span>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Total:</span>
                    <span class="text-success" id="summaryTotal">SAR 0</span>
                  </div>
                </div>

                <div class="mt-3 text-center">
                  <small class="text-muted">
                    <i class="bi bi-shield-lock me-1"></i>
                    Secure SSL encrypted payment
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Form -->
          <div class="col-lg-7">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-1">Complete Your Payment</h6>
                <p class="text-muted mb-0">Enter your payment information to complete the enrollment</p>
              </div>
              <div class="card-body">
                <form id="paymentForm" method="POST" action="{% url 'parents:process_payment' %}">
                  {% csrf_token %}
                  
                  <!-- Hidden fields -->
                  <input type="hidden" id="enrollmentId" name="enrollment_id">
                  <input type="hidden" id="paymentAmount" name="amount">
                  
                  <!-- Payment Method -->
                  <div class="section mb-4">
                    <div class="section-header mb-3">
                      <i class="bi bi-credit-card me-2"></i>
                      <h6 class="mb-0">Payment Method</h6>
                    </div>
                    
                    <div class="mb-3">
                      {% for choice in payment_form.payment_method %}
                      <div class="form-check mb-2">
                        {{ choice.tag }}
                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                          {{ choice.choice_label }}
                          {% if choice.choice_value == 'card' %}
                          <small class="text-muted d-block">Visa, Mastercard, Mada</small>
                          {% elif choice.choice_value == 'transfer' %}
                          <small class="text-muted d-block">Local Saudi banks</small>
                          {% endif %}
                        </label>
                      </div>
                      {% endfor %}
                    </div>

               
                    <div id="card-details" class="card-details">
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="{{ payment_form.cardholder_name.id_for_label }}" class="form-label">
                            Cardholder Name <span class="text-danger">*</span>
                          </label>
                          {{ payment_form.cardholder_name }}
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="{{ payment_form.card_number.id_for_label }}" class="form-label">
                            Card Number <span class="text-danger">*</span>
                          </label>
                          {{ payment_form.card_number }}
                        </div>
                      </div>
                      
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="{{ payment_form.expiry_date.id_for_label }}" class="form-label">
                            Expiry Date <span class="text-danger">*</span>
                          </label>
                          {{ payment_form.expiry_date }}
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="{{ payment_form.cvv.id_for_label }}" class="form-label">
                            CVV <span class="text-danger">*</span>
                          </label>
                          {{ payment_form.cvv }}
                        </div>
                      </div>
                    </div>

             
                    <div id="transfer-details" class="transfer-details" style="display: none;">
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="{{ payment_form.bank_name.id_for_label }}" class="form-label">
                            Bank Name <span class="text-danger">*</span>
                          </label>
                          {{ payment_form.bank_name }}
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="{{ payment_form.account_number.id_for_label }}" class="form-label">
                            Account Number <span class="text-danger">*</span>
                          </label>
                          {{ payment_form.account_number }}
                        </div>
                      </div>
                    </div>
                  </div>

          
                  <div class="section mb-4">
                    <div class="section-header mb-3">
                      <i class="bi bi-chat-text me-2"></i>
                      <h6 class="mb-0">Additional Information</h6>
                    </div>
                    
                    <div class="mb-3">
                      <label for="{{ payment_form.notes.id_for_label }}" class="form-label">
                        Notes (Optional)
                      </label>
                      {{ payment_form.notes }}
                    </div>
                  </div>

              
                  <div class="section mb-4">
                    <div class="form-check mb-3">
                      {{ payment_form.terms_agreement }}
                      <label class="form-check-label" for="{{ payment_form.terms_agreement.id_for_label }}">
                        I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                      </label>
                    </div>
                  </div>

  
                  <div class="d-grid">
                    <button type="submit" class="btn btn-success btn-lg" id="submit-button">
                      Complete Payment - SAR 0
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentPaymentData = {};

function makePayment(academy, program, amount, enrollmentId = null, academySlug = null) {
    currentPaymentData = {
        academy: academy,
        program: program,
        amount: amount,
        enrollmentId: enrollmentId,
        academySlug: academySlug
    };
    
   
    document.getElementById('summaryProgram').textContent = program;
    document.getElementById('summaryAcademy').textContent = academy;
    document.getElementById('summaryAmount').textContent = `SAR ${amount}`;
    
    
    const vat = Math.round((amount * 0.15) * 100) / 100; 
    const total = Math.round((amount + vat) * 100) / 100; 
    
  
    console.log('Payment calculation:', {
        baseAmount: amount,
        vat: vat,
        total: total
    });
    
    document.getElementById('summaryVat').textContent = `SAR ${vat}`;
    document.getElementById('summaryTotal').textContent = `SAR ${total}`;
    document.getElementById('submit-button').textContent = `Complete Payment - SAR ${total}`;
    
  
    if (enrollmentId) {
        document.getElementById('enrollmentId').value = enrollmentId;
    }
   
    document.getElementById('paymentAmount').value = total;
    
  
    if (academySlug) {

        let academySlugField = document.getElementById('academySlug');
        if (!academySlugField) {
            academySlugField = document.createElement('input');
            academySlugField.type = 'hidden';
            academySlugField.name = 'academy_slug';
            academySlugField.id = 'academySlug';
            document.getElementById('paymentForm').appendChild(academySlugField);
        }
        academySlugField.value = academySlug;
    }
    
   
    document.getElementById('paymentForm').reset();
    document.querySelector('input[name="payment_method"][value="card"]').checked = true;
    
    
    new bootstrap.Modal(document.getElementById('paymentModal')).show();
    
    
    togglePaymentMethodDisplay();
}

function selectPaymentMethod(methodName) {
   
    alert(`Selected payment method: ${methodName}`);
}

function subscribeToAcademy(academyName, price, academySlug) {
 
    const mockEnrollment = {
        academy: academyName,
        program: `${academyName} Subscription`,
        amount: price,
        enrollmentId: null, 
        academySlug: academySlug 
    };
    
  
    makePayment(mockEnrollment.academy, mockEnrollment.program, mockEnrollment.amount, mockEnrollment.enrollmentId, mockEnrollment.academySlug);
}

function togglePaymentMethodDisplay() {
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    const cardDetails = document.getElementById('card-details');
    const transferDetails = document.getElementById('transfer-details');
    
    if (paymentMethod && paymentMethod.value === 'card') {
        cardDetails.style.display = 'block';
        transferDetails.style.display = 'none';
    } else if (paymentMethod && paymentMethod.value === 'transfer') {
        cardDetails.style.display = 'none';
        transferDetails.style.display = 'block';
    } else {
        cardDetails.style.display = 'none';
        transferDetails.style.display = 'none';
    }
}


document.addEventListener('DOMContentLoaded', function() {
    const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
    
    paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', togglePaymentMethodDisplay);
    });
    
  
    togglePaymentMethodDisplay();
    
   
    {% if required_academy %}
    const subscriptionsTab = document.querySelector('a[href="#subscriptions"]');
    if (subscriptionsTab) {
        subscriptionsTab.click();
    }
    {% endif %}
});


document.getElementById('paymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitButton = document.getElementById('submit-button');
    
 
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
   
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
    
            alert(data.message || 'Payment processed successfully!' + (data.email_sent ? ' An invoice has been sent to your email.' : ' Note: Invoice email could not be sent.'));
            
        
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            
      
            if (data.subscription_created && data.redirect_url) {
      
                window.location.href = data.redirect_url;
            } else {
        
                location.reload();
            }
        } else {

            alert('Payment failed: ' + (data.error || 'Unknown error occurred'));
            
     
            submitButton.disabled = false;
            submitButton.innerHTML = `Complete Payment - SAR ${document.getElementById('paymentAmount').value}`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Payment failed: Network error occurred');
        
     
        submitButton.disabled = false;
        submitButton.innerHTML = `Complete Payment - SAR ${document.getElementById('paymentAmount').value}`;
    });
});
</script>

{% endblock %}
