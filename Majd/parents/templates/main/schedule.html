{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Schedule{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold">Schedule</h3>
      <p class="text-muted">View and manage your children's training sessions and activities</p>
    </div>
    <div class="d-flex gap-2">
      <!-- ✅ Child Filter -->
      <form method="get" class="d-flex align-items-center">
        <select name="child_id" class="form-select me-2" onchange="this.form.submit()">
          <option value="">All Children</option>
          {% for child in children %}
            <option value="{{ child.id }}" {% if selected_child_id == child.id %}selected{% endif %}>
              {{ child.first_name }} {{ child.last_name }}
            </option>
          {% endfor %}
        </select>
        <noscript><button class="btn btn-success">Filter</button></noscript>
      </form>
      <a href="{% url 'academies:list' %}" class="btn btn-success">
        <i class="bi bi-plus-lg"></i> Enroll Session
      </a>
    </div>
  </div>

  <!-- Tabs -->
  <div class="d-flex justify-content-start mb-4">
    <div class="view-toggle bg-light p-1 rounded-pill d-inline-flex">
      <button id="listViewBtn" class="btn btn-sm px-4 btn-success rounded-pill active">List View</button>
      
    </div>
  </div>

  <!-- List View -->
  <div id="listView">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="fw-bold mb-3">Upcoming Sessions</h5>
        <p class="text-muted small">{{ schedule_items|length }} Sessions</p>

        {% for item in schedule_items %}
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">

            <!-- Left Info -->
            <div class="d-flex align-items-start gap-3">
              <!-- Avatar -->
              <div class="rounded-circle bg-success text-white fw-bold d-flex align-items-center justify-content-center"
                  style="width: 45px; height: 45px;">
                {{ item.child.first_name|slice:":1"|upper }}
              </div>

              <!-- Info -->
              <div>
                <div class="d-flex gap-2">
                  <h6 class="fw-bold mb-0">{{ item.child.first_name }} {{ item.child.last_name }}</h6>
                  <span class="badge bg-light text-dark border">
                    {{ item.session.get_level_display|default:"Session" }}
                  </span>
                </div>
                <p class="mb-0 small text-muted">
                  {{ item.session.program.title|default:"-" }} • {{ item.session.program.academy.name }}
                </p>

                <!-- Date & Location -->
                <div class="text-muted small mt-1">
                  <i class="bi bi-calendar-event me-1"></i>
                  {% if item.next_occurrence.date == today %}
                    Today
                  {% elif item.next_occurrence.date == tomorrow %}
                    Tomorrow
                  {% else %}
                    {{ item.next_occurrence.date|date:"l, M d, Y" }}
                  {% endif %} <br>

                  <i class="bi bi-clock me-1"></i>
                  {{ item.next_occurrence.start_time|time:"H:i" }} - {{ item.next_occurrence.end_time|time:"H:i" }} <br>

                  
                </div>
              </div>
            </div>

            
            
            <!-- Trigger modal -->
            <button class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#sessionModal{{ item.session.id }}">
              View Details
            </button>
            
          </div>
        </div>

        <!-- Session Details Modal -->
        <div class="modal fade" id="sessionModal{{ item.session.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
              
              <!-- Header -->
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">
                  {{ item.session.title }} : {{ item.session.program.academy.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>

              <!-- Body -->
              <div class="modal-body">

                <!-- Trainer -->
                {% if item.session.trainer %}
                <div class="d-flex align-items-center mb-3 p-2 border rounded bg-light">
                  <img src="{{ item.session.trainer.user.profile_image.url|default:'https://via.placeholder.com/40' }}"
                      class="rounded-circle me-2" width="40" height="40" style="object-fit:cover;">
                  <span class="fw-semibold">{{ item.session.trainer.user.get_full_name }}</span>
                </div>
                {% endif %}

                <div class="row mb-3">
                  <div class="col-md-6">
                    <p><strong>Age Range:</strong> {{ item.session.age_min }} - {{ item.session.age_max }} years</p>
                    <p><strong>Gender:</strong> {{ item.session.get_gender_display }}</p>
                    <p><strong>Level:</strong> <span class="badge bg-secondary">{{ item.session.get_level_display }}</span></p>
                  </div>
                  <div class="col-md-6">
                    <p>
                      <strong>Capacity:</strong> 
                      <span class="{% if item.session.enrolled >= item.session.capacity %}text-danger{% else %}text-success{% endif %}">
                        {{ item.session.enrolled }}/{{ item.session.capacity }}
                      </span>
                    </p>
                    <p><strong>Status:</strong> 
                      {% if item.session.enrolled < item.session.capacity %}
                        <span class="badge bg-success">Available</span>
                      {% else %}
                        <span class="badge bg-danger">Full</span>
                      {% endif %}
                    </p>
                    <p><strong>Duration:</strong> {{ item.session.duration_display }} <br>
                      <small>({{ item.session.start_datetime|date:"M d, Y" }} - {{ item.session.end_datetime|date:"M d, Y" }})</small>
                    </p>
                  </div>
                </div>

                <!-- Training Schedule -->
                <div class="mb-3">
                  <h6 class="fw-bold"><i class="bi bi-clock-history me-1"></i> Training Schedule</h6>
                  <ul class="list-group">
                    {% for slot in item.session.slots.all %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ slot.get_weekday_display }}
                        <span>{{ slot.start_time|time:"H:i" }} - {{ slot.end_time|time:"H:i" }}</span>
                      </li>
                    {% empty %}
                      <li class="list-group-item text-muted">No schedule available</li>
                    {% endfor %}
                  </ul>
                </div>



              </div>

              
              <!-- Footer -->
              <div class="modal-footer">
                <form method="post" action="{% url 'parents:unenroll' item.session.id item.child.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Unenroll</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>

            </div>
          </div>
        </div>

        {% endfor %}


      </div>
    </div>
  </div>


</div>
{% endblock %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
.view-toggle {
  border: 1px solid #e0e0e0;
}
.view-toggle .btn {
  font-weight: 500;
  border: none !important;
  box-shadow: none !important;
}
.view-toggle .btn.active {
  background-color: #198754 !important;
  color: #fff !important;
}
.view-toggle .btn:not(.active) {
  background: transparent;
  color: #198754;
}
.view-toggle .btn:hover:not(.active) {
  background: #e6f4ec;
}
</style>





