{% extends "main/base.html" %}
{% load static %}

{% block title %}Checkout - {{ plan.name }} - MAJD{% endblock %}

{% block fileStyle %}
<link rel="stylesheet" href="{% static 'css/accounts.css' %}">
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-start mb-4">
        <a href="{% url 'payment:plan_type_list' %}" class="back-link">
            <i class="bi bi-arrow-left"></i>
            Back to Plans
        </a>
    </div>

    <div class="row">
        <!-- Order Summary -->
        <div class="col-lg-5 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="mb-0">Order Summary</h4>
                </div>
                <div class="card-body">
                    <!-- Selected Plan -->
                    <div class="selected-plan mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="plan-icon me-3">
                                <i class="bi {{ plan.icon_class }}"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">{{ plan.name }} Plan</h5>
                                <span class="badge bg-success" id="billing-badge">Monthly billing</span>
                            </div>
                        </div>
                        <ul class="list-unstyled">
                            {% for feature in plan.features|slice:":3" %}
                            <li class="mb-2">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                {{ feature }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Billing Cycle -->
                    <div class="billing-cycle mb-4">
                        <h6 class="mb-3">Billing Cycle</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="billing" id="monthly" checked>
                            <label class="form-check-label" for="monthly">
                                Monthly - SAR {{ plan.monthly_price }}/month
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="billing" id="yearly">
                            <label class="form-check-label" for="yearly">
                                Yearly - Save 17% - <span id="yearly-price">SAR {{ plan.monthly_price|add:"-102" }}/month (billed yearly)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="cost-breakdown">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">SAR {{ plan.monthly_price }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>VAT (15%):</span>
                            <span id="vat-amount">SAR {% widthratio plan.monthly_price 100 15 %}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>Total:</span>
                            <span class="text-success" id="total-amount">SAR {% widthratio plan.monthly_price 100 115 %}/month</span>
                        </div>
                    </div>

                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="bi bi-shield-lock me-1"></i>
                            Secure SSL encrypted payment
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complete Your Subscription -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-1">Complete Your Subscription</h4>
                    <p class="text-muted mb-0">Enter your academy and payment information to get started</p>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Academy Information -->
                        <div class="section mb-4">
                            <div class="section-header mb-3">
                                <i class="bi bi-building me-2"></i>
                                <h6 class="mb-0">Academy Information</h6>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.academy_name.id_for_label }}" class="form-label">
                                        Academy Name <span class="text-danger">*</span>
                                    </label>
                                    {{ form.academy_name }}
                                    {% if form.academy_name.errors %}
                                    <div class="text-danger small">{{ form.academy_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.contact_email.id_for_label }}" class="form-label">
                                        Contact Email <span class="text-danger">*</span>
                                    </label>
                                    {{ form.contact_email }}
                                    {% if form.contact_email.errors %}
                                    <div class="text-danger small">{{ form.contact_email.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.contact_phone.id_for_label }}" class="form-label">
                                        Contact Phone <span class="text-danger">*</span>
                                    </label>
                                    {{ form.contact_phone }}
                                    {% if form.contact_phone.errors %}
                                    <div class="text-danger small">{{ form.contact_phone.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.city.id_for_label }}" class="form-label">
                                        City <span class="text-danger">*</span>
                                    </label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                    <div class="text-danger small">{{ form.city.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label">
                                    Address <span class="text-danger">*</span>
                                </label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                <div class="text-danger small">{{ form.address.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="section mb-4">
                            <div class="section-header mb-3">
                                <i class="bi bi-credit-card me-2"></i>
                                <h6 class="mb-0">Payment Method</h6>
                            </div>
                            
                            <div class="mb-3">
                                {% for choice in form.payment_method %}
                                <div class="form-check mb-2">
                                    {{ choice.tag }}
                                    <label class="form-check-label" for="{{ choice.id_for_label }}">
                                        {{ choice.choice_label }}
                                        {% if choice.choice_value == 'card' %}
                                        <small class="text-muted d-block">Visa, Mastercard, Mada</small>
                                        {% elif choice.choice_value == 'transfer' %}
                                        <small class="text-muted d-block">Local Saudi banks</small>
                                        {% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Card Details (shown when card is selected) -->
                            <div id="card-details" class="card-details">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.cardholder_name.id_for_label }}" class="form-label">
                                            Cardholder Name <span class="text-danger">*</span>
                                        </label>
                                        {{ form.cardholder_name }}
                                        {% if form.cardholder_name.errors %}
                                        <div class="text-danger small">{{ form.cardholder_name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.card_number.id_for_label }}" class="form-label">
                                            Card Number <span class="text-danger">*</span>
                                        </label>
                                        {{ form.card_number }}
                                        {% if form.card_number.errors %}
                                        <div class="text-danger small">{{ form.card_number.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.expiry_date.id_for_label }}" class="form-label">
                                            Expiry Date <span class="text-danger">*</span>
                                        </label>
                                        {{ form.expiry_date }}
                                        {% if form.expiry_date.errors %}
                                        <div class="text-danger small">{{ form.expiry_date.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.cvv.id_for_label }}" class="form-label">
                                            CVV <span class="text-danger">*</span>
                                        </label>
                                        {{ form.cvv }}
                                        {% if form.cvv.errors %}
                                        <div class="text-danger small">{{ form.cvv.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Agreements -->
                        <div class="section mb-4">
                            <div class="form-check mb-3">
                                {{ form.terms_agreement }}
                                <label class="form-check-label" for="{{ form.terms_agreement.id_for_label }}">
                                    I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                                </label>
                                {% if form.terms_agreement.errors %}
                                <div class="text-danger small">{{ form.terms_agreement.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-check">
                                {{ form.marketing_emails }}
                                <label class="form-check-label" for="{{ form.marketing_emails.id_for_label }}">
                                    Subscribe to product updates and tips (optional)
                                </label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg" id="submit-button">
                                Complete Subscription - SAR {% widthratio plan.monthly_price 100 115 %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
    const cardDetails = document.getElementById('card-details');
    const billingRadios = document.querySelectorAll('input[name="billing"]');
    
    // Get plan price from the page
    const planPrice = {{ plan.monthly_price }};
    const yearlyDiscount = 0.17; // 17% discount
    
    function toggleCardDetails() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
        if (selectedMethod && selectedMethod.value === 'card') {
            cardDetails.style.display = 'block';
        } else {
            cardDetails.style.display = 'none';
        }
    }
    
    function updatePricing() {
        const selectedBilling = document.querySelector('input[name="billing"]:checked');
        let currentPrice, vat, total;
        
        if (selectedBilling && selectedBilling.id === 'yearly') {
            // Yearly pricing with 17% discount
            currentPrice = planPrice * (1 - yearlyDiscount);
            vat = Math.round(currentPrice * 0.15);
            total = currentPrice + vat;
            
            // Update billing badge
            document.getElementById('billing-badge').textContent = 'Yearly billing';
        } else {
            // Monthly pricing
            currentPrice = planPrice;
            vat = Math.round(currentPrice * 0.15);
            total = currentPrice + vat;
            
            // Update billing badge
            document.getElementById('billing-badge').textContent = 'Monthly billing';
        }
        
        // Update cost breakdown
        document.getElementById('subtotal').textContent = `SAR ${Math.round(currentPrice)}`;
        document.getElementById('vat-amount').textContent = `SAR ${vat}`;
        document.getElementById('total-amount').textContent = `SAR ${Math.round(total)}/month`;
        
        // Update submit button
        document.getElementById('submit-button').textContent = `Complete Subscription - SAR ${Math.round(total)}`;
    }
    
    // Payment method toggle
    paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', toggleCardDetails);
    });
    
    // Billing cycle toggle
    billingRadios.forEach(radio => {
        radio.addEventListener('change', updatePricing);
    });
    
    // Initial states
    toggleCardDetails();
    updatePricing();
});
</script>
{% endblock %}
